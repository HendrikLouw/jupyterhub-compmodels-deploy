---
- fail: msg="jupyterhub_admin_user is not defined"
  when: jupyterhub_admin_user == ''
- fail: msg="hub_base_url is not defined"
  when: hub_base_url == ''
- fail: msg="nbgrader_user is not defined"
  when: nbgrader_user == ''
- fail: msg="nbgrader_root is not defined"
  when: nbgrader_root == ''
- fail: msg="course_id is not defined"
  when: course_id == ''

- name: stop and remove formgrader container
  docker:
    docker_api_version: "{{ docker_api_version }}"
    state: absent
    image: compmodels/formgrader
    name: formgrader

- name: copy the grader list to the nbgrader root directory
  template: src=graderlist.j2 dest=/home/{{ nbgrader_user }}/{{ nbgrader_root }}/graderlist

- name: get a jupyterhub api token
  command: docker exec jupyterhub jupyterhub token -f /srv/jupyterhub/jupyterhub_config.py {{ jupyterhub_admin_user }}
  register: jpy_api_token

- name: launch formgrader
  docker:
    docker_api_version: "{{ docker_api_version }}"
    state: running
    image: compmodels/formgrader
    detach: true
    name: formgrader
    net: host
    env:
      JPY_API_TOKEN: "{{ jpy_api_token.stdout }}"
      CONFIGPROXY_AUTH_TOKEN: "{{ configproxy_auth_token }}"
      NOTEBOOK_URL_PREFIX: "{{ nbgrader_root }}"
      HUBAPI_ADDRESS: "{{ servicenet_ip }}"
      HUB_BASE_URL: "{{ hub_base_url }}"
    volumes:
        - /home/{{ nbgrader_user }}/{{ nbgrader_root }}:/srv/formgrader
