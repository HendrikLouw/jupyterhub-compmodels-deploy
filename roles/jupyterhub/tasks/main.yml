---
- fail: msg="configproxy_auth_token is not defined"
  when: configproxy_auth_token == ''
- fail: msg="cookie_secret is not defined"
  when: cookie_secret == ''
- fail: msg="oauth_client_id is not defined"
  when: oauth_client_id == ''
- fail: msg="oauth_client_secret is not defined"
  when: oauth_client_secret == ''
- fail: msg="oauth_callback_url is not defined"
  when: oauth_callback_url == ''
- fail: msg="oauth_hosted_domain is not defined"
  when: oauth_hosted_domain == ''
- fail: msg="admin list is empty"
  when: jupyterhub_admins|length == 0

- name: iptables configuration
  command: iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to 8000

- name: stop and remove jupyterhub container
  docker:
    docker_api_version: "{{ docker_api_version }}"
    state: absent
    image: compmodels/jupyterhub
    name: jupyterhub

- name: create the jupyterhub_db directory
  file: path=/srv/jupyterhub_db state=directory

- name: create jupyterhub.sqlite
  file: path=/srv/jupyterhub_db/jupyterhub.sqlite state=touch mode=0600

- name: create the jupyterhub_users directory
  file: path=/srv/jupyterhub_users state=directory

- name: create the userlist
  template: src=userlist.j2 dest=/srv/jupyterhub_users/userlist

- name: launch jupyterhub
  docker:
    docker_api_version: "{{ docker_api_version }}"
    state: running
    image: compmodels/jupyterhub
    detach: true
    net: host
    name: jupyterhub
    command: -f /srv/jupyterhub_config/jupyterhub_config.py
    env:
      OAUTH_CLIENT_ID: "{{ oauth_client_id }}"
      OAUTH_CLIENT_SECRET: "{{ oauth_client_secret }}"
      OAUTH_CALLBACK_URL: "{{ oauth_callback_url }}"
      HOSTED_DOMAIN: "{{ oauth_hosted_domain }}"
      JPY_COOKIE_SECRET: "{{ cookie_secret }}"
      CONFIGPROXY_AUTH_TOKEN: "{{ configproxy_auth_token }}"
      DOCKER_TLS_CERT: '{{ docker_tls_path }}/cert.pem'
      DOCKER_TLS_KEY: '{{ docker_tls_path }}/key.pem'
      HUB_IP: '{{ servicenet_ip }}'
    volumes:
        - /srv/jupyterhub_db:/srv/jupyterhub_db
        - /srv/jupyterhub_users:/srv/jupyterhub_users
        - "{{ docker_tls_path }}:{{ docker_tls_path }}"
        - /home:/home
